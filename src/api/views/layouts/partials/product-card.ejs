<a href="/products/<%- product._id %>/sku/<%- product.skuId %>" class="block">
  <div class="p-2">
    <div
      class="h-full bg-white rounded-lg shadow-md transition-opacity duration-300 <%= product.stock === 0 ? 'opacity-50' : '' %>"
    >
      <div class="relative p-4 h-full">
        <div class="absolute top-2 right-2">
          <i
            class="far fa-heart add-to-wishlist-link text-gray-600 hover:text-red-500 cursor-pointer text-xl"
            data-product-id="<%- product._id %>"
            data-sku-id="<%- product.skuId %>"
          ></i>
        </div>

        <div class="flex justify-center items-center mb-4 h-36">
          <img
            src="/<%- product.image %>"
            class="h-full object-contain"
            alt="<%- product.name %>"
          />
        </div>

        <h6 class="text-sm font-medium mb-2 h-10 overflow-hidden">
          <%- product.name %>
        </h6>

        <div class="mb-3 text-sm">
          <span class="font-bold text-gray-800"
            >₹<%- product.discountPrice %></span
          >
          <span class="line-through text-gray-400 ml-2"
            >₹<%- product.price %></span
          >
          <span class="text-green-600 ml-2">
            <%- product.discountPercentage %>% off
          </span>
        </div>

        <div class="flex justify-between items-center text-sm">
          <% if (product.stock === 0) { %>
          <span class="text-red-600">Out of Stock</span>
          <% } else { %>
          <span class="text-green-600">In Stock</span>
          <% } %>

          <button
            class="bg-gray-900 text-white text-xs px-2 py-2 rounded add-to-cart-link hover:bg-gray-800 flex items-center space-x-2"
            data-product-id="<%- product._id %>"
            data-sku-id="<%- product.skuId %>"
            data-count="1"
            data-price="<%- product.price %>"
          >
            <i class="fas fa-shopping-cart"></i>
            <span>Add to Cart</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</a>
<div
  id="toast"
  class="fixed bottom-6 right-6 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 pointer-events-none z-50"
  style="width: auto; white-space: nowrap"
></div>

<script>
  const toast = document.getElementById("toast");

  function showToast(message, isSuccess = true) {
    toast.textContent = message;
    toast.classList.remove("opacity-0");
    toast.classList.add("opacity-100");
    toast.classList.add(isSuccess ? "bg-green-600" : "bg-red-600");

    setTimeout(() => {
      toast.classList.remove("opacity-100");
      toast.classList.add("opacity-0");
    }, 2500);
  }

  document.addEventListener("click", async (e) => {
    if (e.target.closest(".add-to-cart-link")) {
      const button = e.target.closest(".add-to-cart-link");
      const productId = button.getAttribute("data-product-id");
      const skuId = button.getAttribute("data-sku-id");
      const count = button.getAttribute("data-count");

      try {
        const response = await fetch("/cart", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ productId, skuId, count }),
        });

        const result = await response.json();
        if (result.success) {
          showToast("Product added to cart successfully", true);
          setTimeout(() => {
            location.reload();
          }, 2000);
        } else {
          showToast(result.message, false);
        }
      } catch (err) {
        console.error("Error adding to cart:", err);
        showToast("Something went wrong while adding to cart.", false);
      }
    }

    if (e.target.closest(".add-to-wishlist-link")) {
      const button = e.target.closest(".add-to-wishlist-link");
      const productId = button.getAttribute("data-product-id");
      const skuId = button.getAttribute("data-sku-id");

      try {
        const response = await fetch("/wishlist", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ productId, skuId }),
        });

        const result = await response.json();
        if (result.success) {
          showToast("Product added to wishlist successfully", true);
          setTimeout(() => {
            location.reload();
          }, 2000);
        } else {
          showToast(result.message, false);
        }
      } catch (err) {
        console.error("Error adding to wishlist:", err);
        showToast("Something went wrong while adding to wishlist.", false);
      }
    }
  });
</script>
